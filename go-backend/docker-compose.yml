version: '3.8'

services:
  # PostgreSQL 数据库服务
  postgres:
    image: postgres:15
    container_name: postgres-db
    restart: always  # 容器停止后自动重启

    # 环境变量配置
    environment:
      # 设置超级用户密码（必需）
      POSTGRES_PASSWORD: 123456
      # 设置默认用户名（默认是 postgres）
      POSTGRES_USER: postgres
      # 创建初始数据库
      POSTGRES_DB: techdb
      # 设置时区
      TZ: Asia/Shanghai

    # 端口映射：主机端口:容器端口
    ports:
      - "5432:5432"

    # 数据卷挂载 - 实现数据持久化
    volumes:
      # 将容器中的数据目录映射到命名卷
      - postgres_data:/var/lib/postgresql/data
      # 可选：挂载初始化脚本目录
      # - ./init-scripts:/docker-entrypoint-initdb.d

    # 健康检查 - 确保数据库正常运行
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

    # 网络配置
    networks:
      - postgres-network

  # 可选：添加 pgAdmin 管理界面
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: always

    environment:
      # pgAdmin 登录邮箱
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      # pgAdmin 登录密码
      PGADMIN_DEFAULT_PASSWORD: admin
      # 禁用服务器模式
      PGADMIN_CONFIG_SERVER_MODE: 'False'

    ports:
      - "5050:80"

    # 依赖 PostgreSQL 服务
    depends_on:
      postgres:
        condition: service_healthy

    networks:
      - postgres-network

# 定义命名卷 - 用于数据持久化
volumes:
  postgres_data:
    driver: local

# 定义网络 - 让服务之间可以通信
networks:
  postgres-network:
    driver: bridge